version: '3.9'

services:
  # PostgreSQL with pgvector extension
  postgres:
    image: ankane/pgvector:latest
    container_name: rag_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-rag_dev}
      POSTGRES_USER: ${POSTGRES_USER:-rag_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rag_password}
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-rag_user} -d ${POSTGRES_DB:-rag_dev}']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rag-network

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: rag_redis
    restart: unless-stopped
    ports:
      - '${REDIS_PORT:-6379}:6379'
    command: ['redis-server', '--save', '60', '1']
    volumes:
      - redisdata:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rag-network

  # Zookeeper for Kafka
  zookeeper:
    image: bitnami/zookeeper:3.9
    container_name: rag_zookeeper
    restart: unless-stopped
    environment:
      ALLOW_ANONYMOUS_LOGIN: 'yes'
    ports:
      - '${ZOOKEEPER_PORT:-2181}:2181'
    networks:
      - rag-network

  # Kafka message queue
  kafka:
    image: bitnami/kafka:3.6.0
    container_name: rag_kafka
    restart: unless-stopped
    ports:
      - '${KAFKA_PORT:-9092}:9092'
    environment:
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_CFG_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_ENABLE_KRAFT: 'no'
    depends_on:
      - zookeeper
    healthcheck:
      test: ['CMD', '/opt/bitnami/kafka/bin/kafka-topics.sh', '--bootstrap-server', 'localhost:9092', '--list']
      interval: 10s
      timeout: 10s
      retries: 10
    networks:
      - rag-network

  # Backend service
  backend:
    build:
      context: ./BACKEND
      dockerfile: Dockerfile
    container_name: rag_backend
    restart: unless-stopped
    ports:
      - '${BACKEND_PORT:-3000}:3000'
    environment:
      # Application
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # Database
      - DATABASE_URL=${DATABASE_URL}
      
      # Redis
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      
      # Kafka
      - KAFKA_BROKER_URL=${KAFKA_BROKER_URL:-kafka:9092}
      - KAFKA_CLIENT_ID=${KAFKA_CLIENT_ID:-rag-microservice}
      - KAFKA_GROUP_ID=${KAFKA_GROUP_ID:-rag-microservice-consumers}
      
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_API_URL=${OPENAI_API_URL:-https://api.openai.com/v1}
      
      # EDUCORE Services
      - LEARNER_AI_SERVICE_URL=${LEARNER_AI_SERVICE_URL}
      - SKILLS_ENGINE_SERVICE_URL=${SKILLS_ENGINE_SERVICE_URL}
      - ASSESSMENT_SERVICE_URL=${ASSESSMENT_SERVICE_URL}
      - DEVLAB_SERVICE_URL=${DEVLAB_SERVICE_URL}
      - ANALYTICS_SERVICE_URL=${ANALYTICS_SERVICE_URL}
      - CONTENT_SERVICE_URL=${CONTENT_SERVICE_URL}
      
      # Coordinator Service (gRPC)
      - COORDINATOR_ENABLED=${COORDINATOR_ENABLED:-true}
      - COORDINATOR_URL=${COORDINATOR_URL:-coordinator}
      - COORDINATOR_GRPC_PORT=${COORDINATOR_GRPC_PORT:-50051}
      - COORDINATOR_GRPC_URL=${COORDINATOR_GRPC_URL:-coordinator:50051}
      - COORDINATOR_PROTO_PATH=${COORDINATOR_PROTO_PATH:-../DATABASE/proto/rag/v1/coordinator.proto}
      - COORDINATOR_SERVICE_NAME=${COORDINATOR_SERVICE_NAME:-rag.v1.CoordinatorService}
      - GRPC_TIMEOUT=${GRPC_TIMEOUT:-30}
      
      # Security
      - RAG_PRIVATE_KEY=${RAG_PRIVATE_KEY}
      - COORDINATOR_PUBLIC_KEY=${COORDINATOR_PUBLIC_KEY}
      - GRPC_USE_SSL=${GRPC_USE_SSL:-false}
      - GRPC_ROOT_CERT=${GRPC_ROOT_CERT}
      
      # AI LEARNER Microservice (gRPC)
      - AI_LEARNER_GRPC_URL=${AI_LEARNER_GRPC_URL}
      - AI_LEARNER_ENABLED=${AI_LEARNER_ENABLED:-true}
      - AI_LEARNER_PROTO_PATH=${AI_LEARNER_PROTO_PATH:-../DATABASE/proto/rag/v1/personalized.proto}
      - AI_LEARNER_SERVICE_NAME=${AI_LEARNER_SERVICE_NAME:-rag.v1.PersonalizedService}
      
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      
      # Frontend URL for CORS
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:80}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    volumes:
      # Mount DATABASE directory for Prisma schema and migrations
      - ./DATABASE:/app/DATABASE:ro
    networks:
      - rag-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:3000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend service
  frontend:
    build:
      context: ./FRONTEND
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:3000}
    container_name: rag_frontend
    restart: unless-stopped
    ports:
      - '${FRONTEND_PORT:-80}:80'
    depends_on:
      - backend
    networks:
      - rag-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  pgdata:
  redisdata:

networks:
  rag-network:
    driver: bridge

