generator client {
  provider = "prisma-client-js"
  output   = "../../BACKEND/node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enable pgvector extension
// Run: CREATE EXTENSION IF NOT EXISTS vector;

// ============================================
// TENANT MANAGEMENT
// ============================================

model Tenant {
  id        String    @id @default(uuid())
  name      String
  domain    String    @unique
  settings  Json?     @default("{}")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  queries             Query[]
  vectorEmbeddings    VectorEmbedding[]
  knowledgeGraphNodes KnowledgeGraphNode[]
  knowledgeGraphEdges KnowledgeGraphEdge[]
  accessControlRules  AccessControlRule[]
  userProfiles        UserProfile[]
  auditLogs           AuditLog[]
  cacheEntries        CacheEntry[]
  microservices       Microservice[]
  microserviceData    MicroserviceData[]

  @@map("tenants")
}

// ============================================
// MICROSERVICE MANAGEMENT
// ============================================

model Microservice {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  name        String   // e.g., "assessment", "devlab", "content", etc.
  serviceId   String   @unique @map("service_id") // Unique identifier across all tenants
  displayName String   @map("display_name")
  description String?  @db.Text
  apiEndpoint String?  @map("api_endpoint")
  version     String?  @default("1.0.0")
  isActive    Boolean  @default(true) @map("is_active")
  settings    Json?    @default("{}")
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vectorEmbeddings VectorEmbedding[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([serviceId])
  @@index([name])
  @@index([isActive])
  @@map("microservices")
}

// ============================================
// QUERY MANAGEMENT
// ============================================

model Query {
  id               String   @id @default(uuid())
  tenantId         String   @map("tenant_id")
  userId           String   @map("user_id")
  sessionId        String?  @map("session_id")
  queryText        String   @map("query_text") @db.Text
  answer           String   @db.Text
  confidenceScore  Decimal  @map("confidence_score") @db.Decimal(3, 2)
  processingTimeMs Int      @map("processing_time_ms")
  modelVersion     String   @map("model_version")
  isPersonalized   Boolean  @default(false) @map("is_personalized")
  isCached         Boolean  @default(false) @map("is_cached")
  metadata         Json?    @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  tenant          Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sources         QuerySource[]
  recommendations QueryRecommendation[]

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([tenantId, sessionId])
  @@map("queries")
}

model QuerySource {
  id                String   @id @default(uuid())
  queryId           String   @map("query_id")
  sourceId          String   @map("source_id")
  sourceType        String   @map("source_type")
  sourceMicroservice String? @map("source_microservice") // Which microservice provided this source
  title             String
  contentSnippet    String   @map("content_snippet") @db.Text
  sourceUrl         String   @map("source_url")
  relevanceScore    Decimal  @map("relevance_score") @db.Decimal(3, 2)
  metadata          Json?    @default("{}")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  query Query @relation(fields: [queryId], references: [id], onDelete: Cascade)

  @@index([queryId])
  @@index([sourceId])
  @@index([sourceMicroservice])
  @@index([sourceType, sourceMicroservice])
  @@map("query_sources")
}

model QueryRecommendation {
  id                 String   @id @default(uuid())
  queryId            String   @map("query_id")
  recommendationType String   @map("recommendation_type")
  recommendationId   String   @map("recommendation_id")
  title              String
  description        String   @db.Text
  reason             String   @db.Text
  priority           Int      @default(0)
  metadata           Json?    @default("{}")
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  query Query @relation(fields: [queryId], references: [id], onDelete: Cascade)

  @@index([queryId])
  @@index([recommendationId])
  @@map("query_recommendations")
}

// ============================================
// VECTOR EMBEDDINGS
// ============================================

model VectorEmbedding {
  id             String                      @id @default(uuid())
  tenantId       String                      @map("tenant_id")
  microserviceId String?                    @map("microservice_id") // Which microservice this content came from
  contentId      String                      @map("content_id")
  contentType    String                      @map("content_type") // "document", "chunk", "kg_node", "query", etc.
  embedding      Unsupported("vector(1536)") // pgvector type
  contentText    String                      @map("content_text") @db.Text
  chunkIndex     Int                         @default(0) @map("chunk_index")
  metadata       Json?                       @default("{}")
  createdAt      DateTime                    @default(now()) @map("created_at")
  updatedAt      DateTime                    @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  microservice Microservice? @relation(fields: [microserviceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([contentId])
  @@index([tenantId, contentId])
  @@index([microserviceId])
  @@index([contentType])
  @@index([tenantId, microserviceId])
  @@index([tenantId, contentType, microserviceId]) // Composite index for filtered searches
  @@map("vector_embeddings")
}

// Note: Vector index created manually via SQL:
// CREATE INDEX ON vector_embeddings USING hnsw (embedding vector_cosine_ops)
// WITH (m = 16, ef_construction = 64);

// ============================================
// KNOWLEDGE GRAPH
// ============================================

model KnowledgeGraphNode {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  nodeId     String   @unique @map("node_id")
  nodeType   String   @map("node_type")
  properties Json?    @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sourceEdges KnowledgeGraphEdge[] @relation("SourceNode")
  targetEdges KnowledgeGraphEdge[] @relation("TargetNode")

  @@index([tenantId])
  @@index([nodeId])
  @@index([nodeType])
  // Note: GIN index for JSONB properties created manually via SQL migration
  // See: DATABASE/prisma/migrations/template_pgvector.sql
  @@map("knowledge_graph_nodes")
}

model KnowledgeGraphEdge {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  sourceNodeId String   @map("source_node_id")
  targetNodeId String   @map("target_node_id")
  edgeType     String   @map("edge_type")
  weight       Decimal? @db.Decimal(3, 2)
  properties   Json?    @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  tenant     Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sourceNode KnowledgeGraphNode @relation("SourceNode", fields: [sourceNodeId], references: [nodeId], onDelete: Cascade)
  targetNode KnowledgeGraphNode @relation("TargetNode", fields: [targetNodeId], references: [nodeId], onDelete: Cascade)

  @@index([tenantId])
  @@index([sourceNodeId, targetNodeId])
  @@index([edgeType])
  @@map("knowledge_graph_edges")
}

// ============================================
// ACCESS CONTROL
// ============================================

model AccessControlRule {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  ruleType     String   @map("rule_type") // "RBAC", "ABAC", "content_permission"
  subjectType  String   @map("subject_type") // "user", "role", "group"
  subjectId    String   @map("subject_id")
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  permission   String
  conditions   Json?    @default("{}")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([subjectType, subjectId])
  @@index([resourceType, resourceId])
  @@index([tenantId, subjectType, subjectId, resourceType, resourceId])
  @@map("access_control_rules")
}

// ============================================
// USER PROFILES (PERSONALIZATION)
// ============================================

model UserProfile {
  id               String   @id @default(uuid())
  tenantId         String   @map("tenant_id")
  userId           String   @unique @map("user_id")
  role             String
  department       String?
  region           String?
  skillGaps        Json?    @default("[]") @map("skill_gaps")
  learningProgress Json?    @default("{}") @map("learning_progress")
  preferences      Json?    @default("{}")
  metadata         Json?    @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId, userId])
  @@index([role])
  @@map("user_profiles")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  userId       String?  @map("user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  details      Json?    @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([action])
  @@map("audit_logs")
}

// ============================================
// CACHE ENTRIES
// ============================================

model CacheEntry {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  cacheKey     String   @unique @map("cache_key")
  queryHash    String   @map("query_hash")
  responseData Json     @map("response_data")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([cacheKey])
  @@index([expiresAt])
  @@map("cache_entries")
}

// ============================================
// MICROSERVICE DATA STORAGE
// ============================================

model MicroserviceData {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  serviceName String   @map("service_name") @db.VarChar(255)
  contentId   String   @map("content_id") @db.VarChar(500)
  contentType String   @map("content_type") @db.VarChar(255)
  contentData Json     @map("content_data") @db.JsonB
  metadata    Json?    @default("{}") @db.JsonB
  timestamp   DateTime @db.Timestamptz
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([serviceName, contentId])
  @@index([serviceName])
  @@index([tenantId])
  @@index([timestamp(sort: Desc)])
  @@index([contentType])
  @@index([contentId])
  @@index([tenantId, serviceName])
  @@map("microservice_data")
}
