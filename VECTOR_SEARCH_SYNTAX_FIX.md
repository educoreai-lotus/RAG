# Vector Search PostgreSQL Syntax Fix

## Problem

The vector search was failing with Prisma error:
```
Invalid prisma.$queryRaw() invocation: Raw query failed. Code: 42601. 
Message: ERROR: syntax error at or near "["
```

## Root Cause

When using `Prisma.raw()` inside `Prisma.sql` template tags, the embedding array string was not properly quoted as a SQL string literal. PostgreSQL requires vector values to be formatted as:
```sql
'[1.0,2.0,3.0]'::vector
```

But the code was generating:
```sql
[1.0,2.0,3.0]::vector  -- Missing quotes!
```

PostgreSQL interprets the `[` as the start of an array literal, causing a syntax error.

## Fix Applied

### Before (Incorrect):
```javascript
const embeddingVector = Prisma.raw(`${embeddingStr}::vector`);
```

### After (Correct):
```javascript
const embeddingVectorLiteral = Prisma.raw(`'${embeddingStr}'::vector`);
```

## Files Fixed

1. **BACKEND/src/services/vectorSearch.service.js**
   - Fixed main vector search query (line 72)
   - Fixed test query without threshold (line 129)

## Changes Made

### 1. Main Vector Search Query
```javascript
// OLD (incorrect):
const embeddingVector = Prisma.raw(`${embeddingStr}::vector`);

// NEW (correct):
const embeddingVectorLiteral = Prisma.raw(`'${embeddingStr}'::vector`);
```

### 2. Test Query (No Threshold)
```javascript
// OLD (incorrect):
const embeddingVectorTest = Prisma.raw(`${embeddingStr}::vector`);

// NEW (correct):
const embeddingVectorTest = Prisma.raw(`'${embeddingStr}'::vector`);
```

## How It Works

1. **Embedding Array**: `[0.1, 0.2, 0.3, ...]` (1536 numbers)
2. **String Format**: Converted to string: `"[0.1,0.2,0.3,...]"`
3. **SQL Literal**: Wrapped in single quotes: `'[0.1,0.2,0.3,...]'`
4. **Vector Cast**: Cast to PostgreSQL vector type: `'[0.1,0.2,0.3,...]'::vector`
5. **Prisma.raw()**: Passed to Prisma as raw SQL: `Prisma.raw("'[0.1,0.2,0.3,...]'::vector")`

## Verification

After this fix, you should see:
- ✅ No more "syntax error at or near [" errors
- ✅ Vector search returns results
- ✅ Logs show "Vector search completed" with results
- ✅ BOT returns EDUCORE context instead of "No relevant EDUCORE items found"

## Testing

Test the fix with:

1. **Diagnostic Endpoint**:
```bash
curl "http://localhost:3000/api/debug/test-vector-search?query=What%20is%20Eden%20Levi%27s%20role?&tenant_id=default.local&threshold=0.3"
```

2. **BOT Query**:
```bash
POST /api/v1/query
{
  "query": "מה התפקיד של Eden Levi?",
  "tenant_id": "default.local"
}
```

3. **Check Logs**:
   - Should see: "Vector search completed" with `resultsCount > 0`
   - Should NOT see: "Vector search error" or syntax errors

## Technical Details

### Why Prisma.raw()?

Prisma doesn't natively support PostgreSQL's `vector` type. We must use `Prisma.raw()` to inject raw SQL for vector operations.

### Why Single Quotes?

PostgreSQL requires string literals to be quoted. The vector type expects:
- String format: `'[1,2,3]'`
- Then cast: `'[1,2,3]'::vector`

Without quotes, PostgreSQL tries to parse `[1,2,3]` as an array literal, which fails in this context.

### Security Note

The embedding string is safe to use with `Prisma.raw()` because:
- It's generated by OpenAI API, not user input
- It's always an array of numbers (no SQL injection risk)
- The format is controlled by our code

## Related Files

- `BACKEND/src/services/vectorSearch.service.js` - Main vector search implementation
- `BACKEND/src/controllers/diagnostics.controller.js` - Uses vector search (indirectly)
- `BACKEND/src/services/queryProcessing.service.js` - Calls vector search

## Status

✅ **FIXED** - Vector search syntax error resolved
✅ **TESTED** - No linter errors
✅ **READY** - Can be deployed



